<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Emsteel AI - Pro Accuracy</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <style>
        :root {
            --emsteel-dark: #121417;
            --emsteel-accent: #00a4e4;
            --success: #2ecc71;
        }
        
        body { 
            margin: 0; background: var(--emsteel-dark); 
            font-family: 'Segoe UI', sans-serif; color: white; 
            overflow: hidden; display: flex; flex-direction: column; align-items: center;
        }

        /* PUBLIC UI - FEEDBACK COUNTS ARE HIDDEN */
        #header-status {
            margin-top: 20px; font-family: monospace; color: #00ff00;
            cursor: pointer; padding: 10px;
        }

        #admin-view {
            display: none; /* Hidden by default */
            background: rgba(0,0,0,0.9); padding: 15px; border-radius: 10px;
            margin-top: 10px; border: 1px solid var(--emsteel-accent);
        }

        .cam-box { 
            position: relative; width: 90%; max-width: 800px; height: 600px; 
            border: 4px solid #333; border-radius: 20px; 
            overflow: hidden; background: #000; margin-top: 20px;
        }

        video, canvas { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        video { display: none; }

        .question {
            margin-top: 30px; font-size: 2.2rem; font-weight: 700;
            text-align: center; max-width: 800px;
        }

        /* Progress Bars */
        .progress-container {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 10px;
            display: flex;
        }
        .p-bar { width: 0%; height: 100%; transition: width 0.1s linear; }
        #happy-bar { background: var(--success); }
        #sad-bar { background: #e74c3c; }

        /* Success Message */
        #success-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(18, 20, 23, 0.96); display: none;
            flex-direction: column; justify-content: center; align-items: center; z-index: 100;
        }
        #success-overlay h1 { font-size: 3.5rem; color: var(--success); margin: 0; }
    </style>
</head>
<body>

    <div id="header-status" onclick="handleAdminClick()">‚óè SYSTEM ACTIVE</div>

    <div id="admin-view">
        HAPPY: <span id="h-count">0</span> | UNHAPPY: <span id="s-count">0</span>
        <button onclick="resetData()" style="margin-left:15px">Reset</button>
    </div>

    <div class="cam-box">
        <video id="webcam"></video>
        <canvas id="overlay"></canvas>
        
        <div id="success-overlay">
            <div id="res-emoji" style="font-size: 7rem;">üòä</div>
            <h1>THANK YOU!</h1>
            <p style="font-size: 1.5rem;">Your feedback is recorded.</p>
        </div>

        <div class="progress-container">
            <div id="happy-bar" class="p-bar"></div>
            <div id="sad-bar" class="p-bar"></div>
        </div>
    </div>

    <div class="question">How was your visit to our booth?</div>
    <p style="color: #666;">Hold a üëç or üëé for 1 second</p>

    <script>
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('overlay');
        const ctx = canvas.getContext('2d');
        const success = document.getElementById('success-overlay');
        
        let counts = JSON.parse(localStorage.getItem('emsteel_v5')) || { happy: 0, sad: 0 };
        let holdTimer = 0;
        let isCoolingDown = false;
        let adminClicks = 0;
        const HOLD_TIME = 1000; // 1 second for fast iPad response

        function updateUI() {
            document.getElementById('h-count').innerText = counts.happy;
            document.getElementById('s-count').innerText = counts.sad;
            localStorage.setItem('emsteel_v5', JSON.stringify(counts));
        }
        updateUI();

        // Admin Secret Toggle
        function handleAdminClick() {
            adminClicks++;
            if(adminClicks >= 3) {
                const panel = document.getElementById('admin-view');
                panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
                adminClicks = 0;
            }
            setTimeout(() => { adminClicks = 0; }, 2000);
        }

        function resetData() {
            if(confirm("Clear all feedback?")) {
                counts = { happy: 0, sad: 0 };
                updateUI();
            }
        }

        function onResults(results) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.save();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0 && !isCoolingDown) {
                const landmarks = results.multiHandLandmarks[0];
                
                // Drawing points for visual feedback
                drawConnectors(ctx, landmarks, HAND_CONNECTIONS, {color: '#00a4e4', lineWidth: 2});

                // FINGERS CLOSED CHECK (Index, Middle, Ring, Pinky)
                // Tips (8, 12, 16, 20) must be lower than knuckles (5, 9, 13, 17)
                const isFist = 
                    landmarks[8].y > landmarks[5].y && 
                    landmarks[12].y > landmarks[9].y && 
                    landmarks[16].y > landmarks[13].y && 
                    landmarks[20].y > landmarks[17].y;

                if (isFist) {
                    const thumbTip = landmarks[4];
                    const thumbJoint = landmarks[3];
                    const indexKnuckle = landmarks[5];

                    let detected = "none";
                    
                    // THUMB UP LOGIC: Tip is significantly higher than index knuckle
                    if (thumbTip.y < indexKnuckle.y - 0.04) {
                        detected = "happy";
                    } 
                    // THUMB DOWN LOGIC: Tip is significantly lower than index knuckle
                    else if (thumbTip.y > indexKnuckle.y + 0.04) {
                        detected = "sad";
                    }

                    if (detected !== "none") {
                        holdTimer += 60; // Frame-based increment
                        document.getElementById(detected === 'happy' ? 'happy-bar' : 'sad-bar').style.width = (holdTimer/HOLD_TIME*100) + "%";
                        
                        if (holdTimer >= HOLD_TIME) {
                            counts[detected]++;
                            updateUI();
                            triggerSuccess(detected);
                        }
                    } else {
                        resetBars();
                    }
                } else {
                    resetBars();
                }
            } else {
                resetBars();
            }
            ctx.restore();
        }

        function resetBars() {
            holdTimer = 0;
            document.getElementById('happy-bar').style.width = "0%";
            document.getElementById('sad-bar').style.width = "0%";
        }

        function triggerSuccess(mood) {
            isCoolingDown = true;
            resetBars();
            document.getElementById('res-emoji').innerText = mood === 'happy' ? 'üòä' : '‚òπÔ∏è';
            success.style.display = 'flex';
            setTimeout(() => {
                success.style.display = 'none';
                isCoolingDown = false;
            }, 3000);
        }

        const hands = new Hands({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
        });
        hands.setOptions({ 
            maxNumHands: 1, 
            modelComplexity: 1, 
            minDetectionConfidence: 0.75, 
            minTrackingConfidence: 0.75 
        });
        hands.onResults(onResults);

        const camera = new Camera(video, {
            onFrame: async () => { await hands.send({image: video}); },
            width: 1280, height: 720
        });
        camera.start();
    </script>
</body>
</html>
